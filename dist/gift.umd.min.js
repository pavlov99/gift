!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(t.gift={})}(this,function(t){"use strict";var r=/([+-]?\d+(\.\d+)?)([eE][+-]?\d+)?/,e=new RegExp(r.source+"((:"+r.source+")|(\\.\\."+r.source+"))?"),n=function(t){function r(){t.apply(this,arguments)}return t&&(r.__proto__=t),r.prototype=Object.create(t&&t.prototype),r.prototype.constructor=r,r}(Error),i=function(t){var r=t.prefix,e=t.credit,i=t.value,o=t.feedback;if(void 0===i)throw new Error("Invalid value '"+i+"', should not be empty");if(this.value=i,void 0!==r&&"="!==r&&"~"!==r)throw new Error("Invalid prefix value: "+r+". Use [undefined, '~', '=']");if(this.prefix=r,void 0!==e){if(this.credit=parseFloat(e),!this.credit)throw new Error("Invalid credit value '"+e+"'. Should be a number.");if(this.credit>1||this.credit<-1)throw new n("Invalid credit value '"+this.credit+"'. Should be in [-1, 1].")}else this.credit=void 0;this.feedback=o};i.prototype.toString=function(){var t=this.prefix?this.prefix:"",r=this.credit?"%"+100*this.credit+"%":"",e=this.feedback?"#"+this.feedback:"";return""+t+r+this.value+e},i.fromString=function(t){var r=t.match(/^([=~])?(%-?\d{1,3}%)?([^=~#]*)(#[^=~]*)?$/);if(r){var e=r[2]?parseFloat(r[2].slice(1,-1))/100:void 0,o=r[4]?r[4].slice(1):void 0;try{return new i({prefix:r[1],credit:e,value:r[3],feedback:o})}catch(t){if(t instanceof n)return new i({prefix:r[1],value:r[2]+r[3],feedback:o})}}};var o=function(t){var r=t.type,e=t.options;void 0===e&&(e=[]),this.type=r,this.options=e};o.splitOptions=function(t){return t.trim().split(/([=~](?:(?:\\[=~#{}])|(?:[^=~]))+)/g).filter(function(t){return t}).map(function(t){return t.trim()})},o.fromString=function(t){if("{"!==t.charAt(0)||"}"!==t.charAt(t.length-1))throw new Error("Block should start with '{' and end with '}': "+t);var r=t.slice(1,-1),n=new RegExp("[=~](%\\d{2}%)?"+e.source+"\\s*(#[^=~]*)?"),u=new RegExp("^(("+e.source+")|((\\s*"+n.source+")+))$");if(/^[\s]*$/.test(r))return new o({type:o.TYPES.TEXT,options:[]});if(/^(TRUE|FALSE|T|F)$/.test(r))return new o({type:o.TYPES.BOOLEAN,options:[new i({value:/^(TRUE|T)$/.test(r)})]});if("#"===r.charAt(0)){if(u.test(r.slice(1))){var s=r.slice(1).split("=").map(function(t){return t.trim()}).filter(Boolean).map(function(t){return i.fromString("="+t)});return new o({type:o.TYPES.NUMBER,options:s})}throw new Error("Invalid number block: "+t)}var c=o.splitOptions(r).map(function(t){return i.fromString(t)});return c.every(function(t){return"~"===t.prefix})?new o({type:o.TYPES.CHECKBOX,options:c}):c.every(function(t){return"="===t.prefix})?c.every(function(t){return t.value.includes("->")})?new o({type:o.TYPES.MATCHING,options:c}):new o({type:o.TYPES.INPUT,options:c}):c.every(function(t){return"~"===t.prefix||"="===t.prefix})?new o({type:o.TYPES.RADIO,options:c}):void 0},o.fromMaskedString=function(t){if("{"!==t.charAt(0)||"}"!==t.charAt(t.length-1))throw new Error("Block should start with '{' and end with '}': "+t);var r=t.slice(1,-1);if(""===r)return new o({type:o.TYPES.TEXT});if("~"===r)return new o({type:o.TYPES.BOOLEAN});if("#"===r)return new o({type:o.TYPES.NUMBER});if("="===r)return new o({type:o.TYPES.INPUT});var e=o.splitOptions(r).map(function(t){return i.fromString(t)});if(e.every(function(t){return"~"===t.prefix}))return new o({type:o.TYPES.CHECKBOX,options:e});if(e.every(function(t){return"="===t.prefix}))return new o({type:o.TYPES.RADIO,options:e});throw Error("Could not parse masked block options")},o.getType=function(t){var r=o.fromString(t);if(r)return r.type},o.isValid=function(t){if("{"!==t.charAt(0)||"}"!==t.charAt(t.length-1))return!1;try{if(void 0===o.fromString(t))return!1}catch(t){return!1}return!0},o.isValidMasked=function(t){try{if(void 0===o.fromMaskedString(t))return!1}catch(t){return!1}return!0},o.prototype.toString=function(){throw this.type,Error("NotImplemented for type "+this.type)},o.prototype.toMaskedString=function(){switch(this.type){case o.TYPES.TEXT:return"{}";case o.TYPES.BOOLEAN:return"{~}";case o.TYPES.NUMBER:return"{#}";case o.TYPES.INPUT:return"{=}";case o.TYPES.RADIO:return"{"+this.options.map(function(t){return"="+t.value}).join(" ")+"}";case o.TYPES.CHECKBOX:return"{"+this.options.map(function(t){return"~"+t.value}).join(" ")+"}";default:throw Error("Could not mask block. Unsupported type "+this.type)}},o.prototype.grade=function(t){switch(this.type){case o.TYPES.RADIO:var r=this.options.filter(function(r){return r.value.trim()===t})[0];return r?r.credit||("="===r.prefix?1:0):0;case o.TYPES.CHECKBOX:var e=new Map(this.options.map(function(t){return[t.value,t.credit]}));return t.map(function(t){return e.get(t)||0}).reduce(function(t,r){return t+r},0);case o.TYPES.BOOLEAN:return this.options[0].value^Boolean(t)?0:1;case o.TYPES.TEXT:return;case o.TYPES.INPUT:return this.options.some(function(r){return r.value.trim()===t})?1:0;case o.TYPES.NUMBER:t=Number(t);var n=this.options.map(function(r){var e=r.credit;void 0===e&&(e=1);var n=r.value;if(n.includes(":")){var i=n.split(":").map(Number),o=i[0],u=i[1];return t>=o-u&&t<=o+u?e:0}if(n.includes("..")){var s=n.split("..").map(Number),c=s[0],a=s[1];return t>=c&&t<=a?e:0}return Number(n)===t?e:0});return Math.max.apply(Math,n);default:throw Error("Grading is not implemented for type "+this.type)}},o.prototype.getFeedback=function(t){switch(this.type){case o.TYPES.RADIO:var r=this.options.filter(function(r){return r.value.trim()===t})[0];return r?r.feedback:void 0;default:throw Error("Grading is not implemented for type "+this.type)}},o.TYPES=Object.freeze({BOOLEAN:"BOOLEAN",NUMBER:"NUMBER",MATCHING:"MATCHING",INPUT:"INPUT",RADIO:"RADIO",CHECKBOX:"CHECKBOX",TEXT:"TEXT"});var u=function(t){void 0===t&&(t=[]),this.blocks=t};u.splitBlocksWithPredicate=function(t,r){var e=[],n=!0;return t.split(/({[^}]*})/g).filter(function(t){return t}).forEach(function(t){n?(e.push(t),n=r(t)):r(t)?(e.push(t),n=!0):e.push(e.pop().concat(t))}),e},u.splitBlocks=function(t){return u.splitBlocksWithPredicate(t,o.isValid)},u.splitMaskedBlocks=function(t){return u.splitBlocksWithPredicate(t,o.isValidMasked)},u.fromString=function(t){return new u(u.splitBlocks(t))},u.prototype.mask=function(){return this.blocks.map(function(t){try{return o.fromString(t).toMaskedString()}catch(t){}return t}).join("")},u.prototype.grade=function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];var e=this.blocks.filter(o.isValid).map(o.fromString);return t.map(function(t,r){return e[r].grade(t)}).reduce(function(t,r){return t+r},0)},t.Block=o,t.Question=u,Object.defineProperty(t,"__esModule",{value:!0})});
